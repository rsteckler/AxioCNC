# NextCNC Cursor Rules

## Project Context
CNCjs frontend modernization ‚Äî replacing legacy React/Webpack with modern React 18 + Vite + TypeScript + Tailwind + shadcn/ui. Backend is Express + Socket.IO (mostly unchanged).

Read `aidocs/overview.md` for full project context and progress.

---

## üõë Protected Code (CRITICAL)

**Do NOT modify these paths without explicit user permission:**
- `src/server/controllers/**` ‚Äî All CNC controller implementations
- `src/server/lib/Sender.js` ‚Äî G-code streaming engine
- `src/server/lib/Feeder.js` ‚Äî Real-time command queue
- `src/server/lib/Workflow.js` ‚Äî Workflow state machine
- `src/server/lib/SerialConnection.js` ‚Äî Serial port communication
- `src/server/lib/EventTrigger.js` ‚Äî Event trigger system
- `src/server/lib/MessageSlot.js` ‚Äî M0/M1 pause handling

These are safety-critical G-code sender components. Bugs can cause machine crashes, tool breakage, or injury. See `aidocs/protected-code.md` for details.

**If you need to modify protected code:** Stop, explain what you want to change and why, then wait for explicit permission.

---

## Tech Stack

| Layer | Technology |
|-------|------------|
| Frontend | React 18, TypeScript, Vite |
| Styling | Tailwind CSS, shadcn/ui, Radix UI |
| State | Redux Toolkit, RTK Query |
| Real-time | Socket.IO v2 client |
| Backend | Express, Socket.IO (do not modify unless asked) |

---

## Build & Development

```bash
# Backend
yarn start-server-dev              # Port 8000

# Frontend  
cd src/app && yarn dev     # Port 5173 (proxies to backend)
cd src/app && yarn build   # Production build
```

**Never start or stop dev servers** ‚Äî Always ask the user to start/stop servers. Do not run `cd src/app && yarn dev`, `yarn start-server-dev`, or kill/restart any running processes. Just tell the user what to run and they will handle it.

---

## Code Conventions

### Frontend (src/app/)
- Use existing shadcn/ui components before creating new ones
- Follow patterns in existing code ‚Äî check similar files first
- TypeScript for all new code
- RTK Query for API calls (`src/app/src/services/api.ts`)

### Naming
- Handlers: `handle{Action}` (e.g., `handleLanguageChange`)
- Props callbacks: `on{Action}` (e.g., `onLanguageChange`)
- Boolean state: `is{State}` or descriptive (e.g., `isSaving`, `allowAnalytics`)

### UI Patterns
- Auto-save with debounce (500ms) ‚Äî no save buttons
- Left accent borders for section headers
- Tooltips for technical explanations, descriptions for user-friendly text
- Axis colors: X=red, Y=green, Z=blue

Read `aidocs/dev_prefs.md` for detailed UI patterns and component guidelines.

---

## API Reference

Backend REST API documented in `docs/API.md`. Key points:
- All endpoints require JWT auth (except `/api/signin`)
- System settings via `/api/settings` (Zod-validated)
- Extension data via `/api/extensions` (schemaless, for widgets/plugins)
- Token stored in localStorage as `cncjs-token`

---

---

## File Structure

```
src/
‚îú‚îÄ‚îÄ app/                    # Modern frontend (work here)
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îú‚îÄ‚îÄ components/     # Reusable UI components
‚îÇ       ‚îú‚îÄ‚îÄ routes/         # Page components
‚îÇ       ‚îú‚îÄ‚îÄ services/       # API and Socket.IO
‚îÇ       ‚îî‚îÄ‚îÄ store/          # Redux store
‚îú‚îÄ‚îÄ app-legacy/             # Original frontend (reference only)
‚îî‚îÄ‚îÄ server/                 # Backend (protected, mostly unchanged)
```

---

## Documentation

| File | Purpose |
|------|---------|
| `aidocs/overview.md` | Project context, progress, architecture |
| `aidocs/dev_prefs.md` | UI patterns, code style, component guidelines |
| `aidocs/protected-code.md` | Protected code boundaries and rationale |
| `docs/API.md` | Complete REST API reference |
| `docs/frontend-features.md` | Feature parity checklist |


---

## Planning & Architecture

**Save project plans in `aidocs/` directory**, not in the default `.cursor/plans/` location. This ensures plans are:
- Version controlled with the project
- Accessible to the team
- Organized with other project documentation

When creating project-specific plans, save them directly to `aidocs/` (e.g., `aidocs/controller-abstraction-layer-plan.md`) rather than using the tool's default home directory location.


# Checking in
WHEN ASKED ONLY!
Your goal is to check in all files that we've modified in this conversation.  Note that other agents may have also touched files, as well as the ones you've worked in.  Your goal is to check in ALL files that have been changed, so you may not have context into some of them if they were left by other agents.
To check in:
1. Look at the uncommitted files to refresh yourself on the changes
2. Look at the diffs to refresh on the intent of the changes
3. Create meaningful, concise commit comments.  If you don't have enough context on a change, try to make your best guess as to the intent.
4. commit the files
5. push the changes to the remote

Success looks like a clean working directory.  If there are things that should NOT be checked in, let the human know and ask for permission to add them to the .gitignore, then commit/push that file.

Here are some guidelines for commits
## Git Commits & Check-ins

### Commit Message Format

Use conventional commit format with category prefixes:

```
<type>(<scope>): <description>

[optional body with details]

[optional footer with breaking changes or issue refs]
```

**Types:**
| Type | Use For |
|------|---------|
| `feat` | New features |
| `fix` | Bug fixes |
| `refactor` | Code restructuring (no behavior change) |
| `style` | Formatting, whitespace, CSS changes |
| `docs` | Documentation only |
| `chore` | Build, config, dependencies |
| `test` | Adding or updating tests |

**Scopes:** `frontend`, `backend`, `api`, `settings`, `ui`, `schema`, `docs`

**Examples:**
```
feat(api): add validated /api/settings endpoint with Zod schema
fix(frontend): correct prop name in AppearanceSection
refactor(settings): migrate from state API to settings/extensions split
docs(api): update API.md with new settings and extensions endpoints
chore(deps): add zod to frontend and backend packages
```

### Commit Granularity

**DO commit separately:**
- Each self-contained feature or fix
- Schema changes (separate from API changes)
- Frontend and backend changes (when they can stand alone)
- Documentation updates
- Dependency additions

**DON'T bundle:**
- Unrelated changes in one commit
- "WIP" commits with incomplete work
- Multiple features in one commit

### Check-in Workflow


1. **Stage & Review**
   - Run `git status` to see all changes
   - Group changes by logical concern
   - Identify if multiple commits are needed

2. **Prepare Commit Message(s)**
   - Draft descriptive commit message(s)
   - List affected files
   - Present to user for approval:
   ```
   üìù Proposed commit:
   
   feat(api): add settings and extensions API endpoints
   
   - Create Zod schema for system settings validation
   - Add /api/settings endpoint (validated)
   - Rename /api/state to /api/extensions (schemaless)
   - Update configstore defaults
   
   Files: src/shared/schemas/*, src/server/api/api.settings.js, ...
   
   Approve? (y/n/edit)
   ```

3. **Pre-push Checks**
   - Run linting on changed files
   - Check for TypeScript errors
   - Report any issues:
   ```
   ‚ö†Ô∏è Found 2 issues before push:
   - src/app/src/routes/Settings/index.tsx:188 - unused variable 'customThemes'
   - src/server/api/api.settings.js:45 - missing semicolon
   
   Fix these before pushing? (y/n)
   ```

4. **Push**
   - After approval and fixes, push to remote
   - Report success or any push errors

