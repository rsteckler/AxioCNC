# NextCNC Cursor Rules

## Project Context
CNCjs frontend modernization â€” replacing legacy React/Webpack with modern React 18 + Vite + TypeScript + Tailwind + shadcn/ui. Backend is Express + Socket.IO (mostly unchanged).

Read `aidocs/overview.md` for full project context and progress.

---

## ğŸ›‘ Protected Code (CRITICAL)

**Do NOT modify these paths without explicit user permission:**
- `src/server/controllers/**` â€” All CNC controller implementations
- `src/server/lib/Sender.js` â€” G-code streaming engine
- `src/server/lib/Feeder.js` â€” Real-time command queue
- `src/server/lib/Workflow.js` â€” Workflow state machine
- `src/server/lib/SerialConnection.js` â€” Serial port communication
- `src/server/lib/EventTrigger.js` â€” Event trigger system
- `src/server/lib/MessageSlot.js` â€” M0/M1 pause handling

These are safety-critical G-code sender components. Bugs can cause machine crashes, tool breakage, or injury. See `aidocs/protected-code.md` for details.

**If you need to modify protected code:** Stop, explain what you want to change and why, then wait for explicit permission.

---

## Tech Stack

| Layer | Technology |
|-------|------------|
| Frontend | React 18, TypeScript, Vite |
| Styling | Tailwind CSS, shadcn/ui, Radix UI |
| State | Redux Toolkit, RTK Query |
| Real-time | Socket.IO v2 client |
| Backend | Express, Socket.IO (do not modify unless asked) |

---

## Build & Development

```bash
# Backend
yarn start-server-dev              # Port 8000

# Frontend  
cd src/app && npm run dev          # Port 5173 (proxies to backend)
cd src/app && npm run build        # Production build
```

**Never run Android/Gradle builds** â€” User handles all compilation in Android Studio.

**Never start or stop dev servers** â€” Always ask the user to start/stop servers. Do not run `npm run dev`, `yarn start-server-dev`, or kill/restart any running processes. Just tell the user what to run and they will handle it.

---

## Code Conventions

### Frontend (src/app/)
- Use existing shadcn/ui components before creating new ones
- Follow patterns in existing code â€” check similar files first
- TypeScript for all new code
- RTK Query for API calls (`src/app/src/services/api.ts`)

### Naming
- Handlers: `handle{Action}` (e.g., `handleLanguageChange`)
- Props callbacks: `on{Action}` (e.g., `onLanguageChange`)
- Boolean state: `is{State}` or descriptive (e.g., `isSaving`, `allowAnalytics`)

### UI Patterns
- Auto-save with debounce (500ms) â€” no save buttons
- Left accent borders for section headers
- Tooltips for technical explanations, descriptions for user-friendly text
- Axis colors: X=red, Y=green, Z=blue

Read `aidocs/dev_prefs.md` for detailed UI patterns and component guidelines.

---

## API Reference

Backend REST API documented in `docs/API.md`. Key points:
- All endpoints require JWT auth (except `/api/signin`)
- System settings via `/api/settings` (Zod-validated)
- Extension data via `/api/extensions` (schemaless, for widgets/plugins)
- Token stored in localStorage as `cncjs-token`

---

## Git Commits & Check-ins

### Commit Message Format

Use conventional commit format with category prefixes:

```
<type>(<scope>): <description>

[optional body with details]

[optional footer with breaking changes or issue refs]
```

**Types:**
| Type | Use For |
|------|---------|
| `feat` | New features |
| `fix` | Bug fixes |
| `refactor` | Code restructuring (no behavior change) |
| `style` | Formatting, whitespace, CSS changes |
| `docs` | Documentation only |
| `chore` | Build, config, dependencies |
| `test` | Adding or updating tests |

**Scopes:** `frontend`, `backend`, `api`, `settings`, `ui`, `schema`, `docs`

**Examples:**
```
feat(api): add validated /api/settings endpoint with Zod schema
fix(frontend): correct prop name in AppearanceSection
refactor(settings): migrate from state API to settings/extensions split
docs(api): update API.md with new settings and extensions endpoints
chore(deps): add zod to frontend and backend packages
```

### Commit Granularity

**DO commit separately:**
- Each self-contained feature or fix
- Schema changes (separate from API changes)
- Frontend and backend changes (when they can stand alone)
- Documentation updates
- Dependency additions

**DON'T bundle:**
- Unrelated changes in one commit
- "WIP" commits with incomplete work
- Multiple features in one commit

### When to Suggest Commits

**Proactively suggest a commit when:**
1. A logical unit of work is complete (e.g., new API endpoint works)
2. Before starting a different type of change
3. After completing each TODO item in a multi-step task
4. When file count exceeds 5-6 files on a single concern
5. Before risky or experimental changes (create a checkpoint)

**Prompt format:**
> ğŸ”” **Commit checkpoint:** [description of completed work]. This is a good point to commit before [next task]. Want me to prepare the commit?

### Check-in Workflow

When user says "check in the code" or "commit this":

1. **Stage & Review**
   - Run `git status` to see all changes
   - Group changes by logical concern
   - Identify if multiple commits are needed

2. **Prepare Commit Message(s)**
   - Draft descriptive commit message(s)
   - List affected files
   - Present to user for approval:
   ```
   ğŸ“ Proposed commit:
   
   feat(api): add settings and extensions API endpoints
   
   - Create Zod schema for system settings validation
   - Add /api/settings endpoint (validated)
   - Rename /api/state to /api/extensions (schemaless)
   - Update configstore defaults
   
   Files: src/shared/schemas/*, src/server/api/api.settings.js, ...
   
   Approve? (y/n/edit)
   ```

3. **Pre-push Checks**
   - Run linting on changed files
   - Check for TypeScript errors
   - Report any issues:
   ```
   âš ï¸ Found 2 issues before push:
   - src/app/src/routes/Settings/index.tsx:188 - unused variable 'customThemes'
   - src/server/api/api.settings.js:45 - missing semicolon
   
   Fix these before pushing? (y/n)
   ```

4. **Push**
   - After approval and fixes, push to remote
   - Report success or any push errors

### Quick Commands

| User Says | Action |
|-----------|--------|
| "check in" / "commit this" | Full workflow above |
| "quick commit" | Commit all staged with auto-generated message, still ask approval |
| "checkpoint" | Suggest logical commit points for current work |
| "what's changed?" | Show `git status` and `git diff --stat` |

---

## File Structure

```
src/
â”œâ”€â”€ app/                    # Modern frontend (work here)
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ components/     # Reusable UI components
â”‚       â”œâ”€â”€ routes/         # Page components
â”‚       â”œâ”€â”€ services/       # API and Socket.IO
â”‚       â””â”€â”€ store/          # Redux store
â”œâ”€â”€ app-legacy/             # Original frontend (reference only)
â””â”€â”€ server/                 # Backend (protected, mostly unchanged)
```

---

## Documentation

| File | Purpose |
|------|---------|
| `aidocs/overview.md` | Project context, progress, architecture |
| `aidocs/dev_prefs.md` | UI patterns, code style, component guidelines |
| `aidocs/protected-code.md` | Protected code boundaries and rationale |
| `docs/API.md` | Complete REST API reference |
| `docs/frontend-features.md` | Feature parity checklist |


---

## Planning & Architecture

**Save project plans in `aidocs/` directory**, not in the default `.cursor/plans/` location. This ensures plans are:
- Version controlled with the project
- Accessible to the team
- Organized with other project documentation

When creating project-specific plans, save them directly to `aidocs/` (e.g., `aidocs/controller-abstraction-layer-plan.md`) rather than using the tool's default home directory location.
